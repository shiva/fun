CMAKE_MINIMUM_REQUIRED(VERSION 2.6)
PROJECT(blackhole)

LIST(APPEND CMAKE_MODULE_PATH "${CMAKE_SOURCE_DIR}/cmake")

SET(CMAKE_INSTALL_RPATH_USE_LINK_PATH TRUE)

SET(BLACKHOLE_VERSION_MAJOR 0)
SET(BLACKHOLE_VERSION_MINOR 5)
SET(BLACKHOLE_VERSION_PATCH 0)
SET(BLACKHOLE_VERSION "${BLACKHOLE_VERSION_MAJOR}.${BLACKHOLE_VERSION_MINOR}.${BLACKHOLE_VERSION_PATCH}")

# Evaluate ABI version number.
MATH(EXPR BLACKHOLE_ABI_VERSION_SUFFIX "${BLACKHOLE_VERSION_MAJOR} * 10000 + ${BLACKHOLE_VERSION_MINOR} * 100 + ${BLACKHOLE_VERSION_PATCH} * 1")

SET(BLACKHOLE_ABI_VERSION v${BLACKHOLE_ABI_VERSION_SUFFIX})

OPTION(BLACKHOLE_HEADER_ONLY "Build as header-only library" ON)
OPTION(BLACKHOLE_DEBUG "Enable debugging messages support" ON)
OPTION(ENABLE_TESTING "Enable testing" OFF)
OPTION(ENABLE_TESTING_THREAD, "Enable testing in multithreaded environment" OFF)
OPTION(ENABLE_TESTING_COVERAGE, "Enable generating code coverage report" OFF)
OPTION(ENABLE_EXAMPLES "Enable examples" OFF)
OPTION(ENABLE_BENCHMARKING "Enable benchmarking" OFF)
OPTION(ENABLE_ELASTICSEARCH "Enable elasticsearch sink" OFF)
OPTION(ENABLE_ELASTICSEARCH_DEBUG "Enable elasticsearch debug" OFF)
OPTION(ENABLE_TRACING_FRAMEWORK "Enable tracing framework" OFF)
OPTION(ENABLE_DOCUMENTATION_GENERATION "Generate documentation by Doxygen" OFF)

CONFIGURE_FILE(
    ${PROJECT_SOURCE_DIR}/config.hpp.in
    ${PROJECT_SOURCE_DIR}/src/blackhole/config.hpp
)

ADD_SUBDIRECTORY(src)

IF(ENABLE_DOCUMENTATION_GENERATION)
    MESSAGE("-- Checking for Doxygen ...")
    FIND_PACKAGE(Doxygen)
ENDIF()

IF(DOXYGEN_FOUND)
    SET(DOC_TARGET "doc")

    ADD_SUBDIRECTORY(doc)
    CONFIGURE_FILE(
        doc/Doxyfile.in
        ${CMAKE_CURRENT_BINARY_DIR}/doc/Doxyfile
        @ONLY
    )

    ADD_CUSTOM_TARGET(${DOC_TARGET}
        ${DOXYGEN_EXECUTABLE} ${CMAKE_CURRENT_BINARY_DIR}/doc/Doxyfile
        COMMENT "Building documentation"
        SOURCE doc/Doxyfile.in
    )
ENDIF()
